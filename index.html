<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>晉欣鮮食廠｜半成品儀表板</title>
  <link rel="icon" href="data:," />

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap');
    :root {
      --bg1:#f8fafc;
      --bg2:#eef2ff;
      --card:#ffffff;
      --muted:#64748b;
      --ink:#0f172a;
      --line:#e2e8f0;
      --accent:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
    }
    body {
      font-family: 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
      background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
      color: var(--ink);
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 1px 0 rgba(15, 23, 42, 0.02);
    }
    .chip {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
      background: #fff;
    }
    .seg-btn {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 14px;
      background: #fff;
      color: #0f172a;
      transition: all .15s ease;
      user-select: none;
    }
    .seg-btn.active {
      background: #0f172a;
      color: #fff;
      border-color: #0f172a;
    }
    .kpi-card-title {
      font-size: 13px;
      color: var(--muted);
    }
    .kpi-card-value {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .subval {
      font-size: 12px;
      color: var(--muted);
    }
    .table-wrap {
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #f8fafc;
      border-bottom: 1px solid var(--line);
      padding: 10px 12px;
      font-size: 12px;
      color: #334155;
      text-align: left;
      white-space: nowrap;
    }
    tbody td {
      border-bottom: 1px solid #f1f5f9;
      padding: 10px 12px;
      font-size: 13px;
      vertical-align: top;
    }
    tbody tr:hover {
      background: #f8fafc;
    }
    .mono {
      font-variant-numeric: tabular-nums;
    }
    .muted {
      color: var(--muted);
    }
    .badge-ok {
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;
      font-size:12px;
    }
    .badge-danger {
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      background:#fef2f2;color:#991b1b;border:1px solid #fecaca;
      font-size:12px;
    }
    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      max-width: 420px;
      background: #0f172a;
      color: #fff;
      padding: 12px 14px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      display: none;
      z-index: 50;
    }
    .loader {
      width: 18px;
      height: 18px;
      border: 2px solid #cbd5e1;
      border-top-color: #0f172a;
      border-radius: 999px;
      animation: spin 0.8s linear infinite;
      display:inline-block;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  .sticky-pane{position:sticky;top:12px;z-index:40;}
.sticky-pane.is-stuck{box-shadow:0 12px 30px rgba(15,23,42,.12);}
@media (max-width:640px){.sticky-pane{top:8px;}}
</style>

  <!-- Local vendor scripts (GitHub Pages 同網域) -->
  <script src="./xlsx.full.min.js"></script>
  <script src="./chart.umd.min.js"></script>
</head>

<body class="min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Header -->
    <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">晉欣鮮食廠｜半成品儀表板</h1>
      </div>
      <div class="flex flex-wrap gap-2 items-center">
        <span id="dataStatus" class="chip">尚未載入資料</span>
        <button id="reloadBtn" class="seg-btn">重新載入</button>
      </div>
    </div>

    <!-- Controls -->
    <div id="stickySentinel" class="h-px"></div>
    <div id="controlsCard" class="mt-4 card p-4 sticky-pane">
      <div class="flex flex-col gap-4">
        <div class="flex flex-wrap items-center gap-2">
          <div class="text-sm font-semibold mr-2">選擇時間範圍</div>
          <button class="seg-btn active" data-mode="year">年別</button>
          <button class="seg-btn" data-mode="month">月別</button>
          <button class="seg-btn" data-mode="week">週別</button>
          <button class="seg-btn" data-mode="day">日別</button>
          <button class="seg-btn" data-mode="range">指定範圍</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
          <div class="md:col-span-3" id="yearWrap">
            <label class="text-xs muted">年別（目前內建為 2025 / 2026）</label>
            <select id="yearSel" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 bg-white"></select>
          </div>

          <div class="md:col-span-3 hidden" id="monthWrap">
            <label class="text-xs muted">月別</label>
            <select id="monthSel" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 bg-white"></select>
          </div>

          <div class="md:col-span-4 hidden" id="weekWrap">
            <label class="text-xs muted">週別（週二至週一）</label>
            <select id="weekSel" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 bg-white"></select>
          </div>

          <div class="md:col-span-3 hidden" id="dayWrap">
            <label class="text-xs muted">日別</label>
            <input id="daySel" type="date" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 bg-white" />
          </div>

          <div class="md:col-span-5 hidden" id="rangeWrap">
            <label class="text-xs muted">日期範圍</label>
            <div class="mt-1 grid grid-cols-2 gap-2">
              <input id="rangeStart" type="date" class="w-full rounded-xl border border-slate-200 px-3 py-2 bg-white" />
              <input id="rangeEnd" type="date" class="w-full rounded-xl border border-slate-200 px-3 py-2 bg-white" />
            </div>
          </div>
          <div class="md:col-span-3 flex gap-2">
            <button id="applyBtn" class="seg-btn w-full">套用</button>
            <button id="todayBtn" class="seg-btn w-full">跳到最新日</button>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
      <div class="card p-4">
        <div class="kpi-card-title">營業額（平均/日）</div>
        <div id="kpiSales" class="kpi-card-value mono mt-1">—</div>
</div>
      <div class="card p-4">
        <div class="kpi-card-title">報廢額（平均/日）</div>
        <div id="kpiScrapAmt" class="kpi-card-value mono mt-1">—</div>
</div>
      <div class="card p-4">
        <div class="kpi-card-title">報廢率（平均）</div>
        <div id="kpiScrapRate" class="kpi-card-value mono mt-1">—</div>
</div>
      <div class="card p-4">
        <div class="kpi-card-title">超用額（平均/日）</div>
        <div id="kpiOverAmt" class="kpi-card-value mono mt-1">—</div>
</div>
      <div class="card p-4">
        <div class="kpi-card-title">超用率（平均）</div>
        <div id="kpiOverRate" class="kpi-card-value mono mt-1">—</div>
</div>
    </div>

    <!-- Top cards -->
    <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
      <div class="card p-4">
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="kpi-card-title">廢棄前10名（平均/日）</div>
            <div id="topScrapAmt" class="kpi-card-value mono mt-1">—</div>
            <div class="subval mt-1">構成比（平均）：<span id="topScrapShare" class="mono">—</span></div>
          </div>
          
        </div>
      </div>

      <div class="card p-4">
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="kpi-card-title">超用前10名（平均/日）</div>
            <div id="topOverAmt" class="kpi-card-value mono mt-1">—</div>
            <div class="subval mt-1">構成比（平均）：<span id="topOverShare" class="mono">—</span></div>
          </div>
          
        </div>
      </div>

      <div class="card p-4">
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="kpi-card-title">共用類廢棄（平均/日）</div>
            <div id="sharedAmt" class="kpi-card-value mono mt-1">—</div>
            <div class="subval mt-1 flex items-center gap-2">
              構成比（平均，KPI 15%）：<span id="sharedShare" class="mono">—</span>
              <span id="sharedBadge" class="hidden"></span>
            </div>
          </div>
          
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3">
      <div class="card p-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">KPI 趨勢圖</div>
            
          </div>
          
          <div class="flex flex-wrap gap-2 items-center" id="kpiSingleWrap">
            <button class="seg-btn active" type="button" data-kpi-single="sales">營業額</button>
            <button class="seg-btn" type="button" data-kpi-single="scrapAmt">報廢額</button>
            <button class="seg-btn" type="button" data-kpi-single="scrapRate">報廢率</button>
            <button class="seg-btn" type="button" data-kpi-single="overuseAmt">超用額</button>
            <button class="seg-btn" type="button" data-kpi-single="overuseRate">超用率</button>
          </div>
        </div>
        <div class="mt-3">
          <canvas id="kpiChart" height="220"></canvas>
        </div>
      </div>

      <div class="card p-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">廢棄／超用 趨勢圖</div>
            
          </div>
          <div class="flex flex-wrap gap-2 items-center">
            <div class="flex flex-wrap gap-2 items-center">
              <button class="seg-btn active" data-right="scrapTop10">廢棄前10名</button>
              <button class="seg-btn" data-right="overTop10">超用前10名</button>
              <button class="seg-btn" data-right="shared">共用類廢棄</button>
            </div>
            <div class="h-6 w-px bg-slate-200 mx-1"></div>
            <div class="flex flex-wrap gap-2 items-center">
              <button class="seg-btn active" data-right-metric="amt">金額</button>
              <button class="seg-btn" data-right-metric="share">構成比</button>
            </div>
          </div>
        </div>
        <div class="mt-3">
          <canvas id="rightChart" height="220"></canvas>
        </div>
      </div>
    </div>

    <!-- Semi-product expansion -->
    <div class="mt-4 card p-4">
      <div class="flex flex-col gap-3">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">半成品展開</div>
</div>
          <div class="flex flex-wrap gap-2 items-center">
            <div class="text-xs muted">排序依據</div>
            <select id="sortSel" class="rounded-xl border border-slate-200 px-3 py-2 bg-white">
              <option value="diffAmt">差異金額（高→低）</option>
              <option value="scrapAmt">報廢金額（高→低）</option>
              <option value="overuseAmt">超用金額（高→低）</option>
              <option value="refillQty">補單量（高→低）</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-end">
          <div class="lg:col-span-5">
            <label class="text-xs muted">品名搜尋（輸入關鍵字）</label>
            <input id="productSearch" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 bg-white" placeholder="" />
            <div id="productSuggest" class="mt-1 hidden"></div>
          </div>
          <div class="lg:col-span-5">
            <label class="text-xs muted">半成品名搜尋（輸入關鍵字）</label>
            <input id="semiSearch" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 bg-white" placeholder="" />
            <div id="semiSuggest" class="mt-1 hidden"></div>
          </div>
          <div class="lg:col-span-2 flex gap-2">
            <button id="clearSearchBtn" class="seg-btn w-full">清除</button>
          </div>
        </div>

        <div class="table-wrap">
          <div class="px-3 py-2 bg-slate-50 border-b border-slate-200 text-xs muted flex flex-wrap items-center justify-between gap-2">
            <div>顯示：<span id="groupCount">0</span> 筆（最多 200 筆）</div>
</div>
          <div class="overflow-auto max-h-[420px]">
            <table>
              <thead>
                <tr>
                  <th>商品名</th>
                  <th>半成品名</th>
                  <th class="text-right">補單</th>
                  <th class="text-right">實際生產率</th>
                  <th class="text-right">差異金額</th>
                  <th class="text-right">報廢金額</th>
                  <th class="text-right">超用金額</th>
                </tr>
              </thead>
              <tbody id="groupTbody"></tbody>
            </table>
          </div>
        </div>

        <!-- Selected item -->
        <div id="itemPanel" class="hidden mt-2">
          <div class="flex flex-col gap-2">
            <div class="flex flex-wrap items-end justify-between gap-3">
              <div>
                <div class="text-sm font-semibold">商品趨勢圖與日別明細</div>
                <div id="itemTitle" class="text-xs muted mt-1">—</div>
              </div>
              <div class="flex flex-wrap gap-2 items-center" id="itemMetricWrap">
                <button class="seg-btn" type="button" data-item-single="prodRate">實際生產率</button>
                <button class="seg-btn active" type="button" data-item-single="diffAmt">差異金額</button>
                <button class="seg-btn" type="button" data-item-single="scrapAmt">報廢金額</button>
                <button class="seg-btn" type="button" data-item-single="overuseAmt">超用金額</button>
                <button class="seg-btn" type="button" data-item-single="refillQty">補單量</button>
              </div>
            </div>

            <div class="card p-3">
              <canvas id="itemChart" height="240"></canvas>
            </div>

            <div class="table-wrap">
              <div class="px-3 py-2 bg-slate-50 border-b border-slate-200 text-xs muted flex flex-wrap items-center justify-between gap-2">
                <div>日別明細（依日期排序）</div>
                <div class="flex gap-2">
                  <button id="exportCsvBtn" class="seg-btn">下載 CSV</button>
                </div>
              </div>
              <div class="overflow-auto max-h-[420px]">
                <table>
                  <thead>
                    <tr>
                      <th>日期</th>
                      <th>商品名</th>
                      <th>半成品名</th>
                      <th class="text-right">訂單需求</th>
                      <th class="text-right">實際產出</th>
                      <th class="text-right">補單</th>
                      <th class="text-right">單價</th>
                      <th class="text-right">實際生產率</th>
                      <th class="text-right">差異量</th>
                      <th class="text-right">差異金額</th>
                      <th class="text-right">報廢量</th>
                      <th class="text-right">報廢金額</th>
                      <th class="text-right">超用量</th>
                      <th class="text-right">超用金額</th>
                    </tr>
                  </thead>
                  <tbody id="detailTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* =========================
   晉欣鮮食廠｜半成品儀表板
   - GitHub Pages 版：同網域讀取 ./data/*.xlsx
   - 需要 XLSX (SheetJS) 與 Chart.js
========================= */

const state = {
  loaded: false,
  summary: [],
  details: [],
  dateMin: null,
  dateMax: null,
  years: [],
  months: [],
  weeks: [],
  mode: 'year',             // year|month|week|day|range
  gran: 'auto',             // auto|day|week|month
  selection: {
    year: null,
    month: null,
    weekStart: null,
    day: null,
    start: null,
    end: null
  },
  kpiSelected: ['sales'],
  itemMetricSelected: 'diffAmt',
  rightMode: 'scrapTop10',
  rightMetric: 'amt',
  groupRows: [],
  filteredGroups: [],
  selectedKey: null,
  selectedDaily: [],
  charts: {
    kpi: null,
    right: null,
    item: null
  },
  _groupRangeKey: null
};
const $ = (id) => document.getElementById(id);
const toast = (msg) => {
  const el = $('toast');
  el.textContent = msg;
  el.style.display = 'block';
  clearTimeout(el._t);
  el._t = setTimeout(() => el.style.display = 'none', 3000);
};


// --- date/string helpers (避免 null.localeCompare、parseISO 未定義而中斷) ---
function safeStr(x){ return (x===null || x===undefined) ? '' : String(x); }
function safeLocaleCompare(a,b){ return safeStr(a).localeCompare(safeStr(b)); }


function initStickyControls(){
  const sentinel = document.getElementById('stickySentinel');
  const pane = document.getElementById('controlsCard');
  if (!sentinel || !pane) return;
  // IntersectionObserver: 當 sentinel 捲出視窗上緣 => pane 進入「凍結」狀態
  const obs = new IntersectionObserver((entries)=>{
    const ent = entries[0];
    // 當 sentinel 不可見（被捲走）代表已開始 stick
    if (!ent.isIntersecting) pane.classList.add('is-stuck');
    else pane.classList.remove('is-stuck');
  }, {root:null, threshold:0});
  obs.observe(sentinel);
}

const fmtInt = (n) => (Number.isFinite(n) ? n.toLocaleString('zh-TW') : '—');
const fmtMoney = (n) => {
  if (!Number.isFinite(n)) return '—';
  const v = Math.round(n);
  return 'NT$ ' + v.toLocaleString('zh-TW');
};
const fmtPct = (n) => {
  if (!Number.isFinite(n)) return '—';
  return (n * 100).toFixed(2) + '%';
};
const shortLabel = (s) => {
  if (typeof s !== 'string') return String(s ?? '');
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s.slice(5); // MM-DD
  if (/^\d{4}-\d{2}$/.test(s)) return s.slice(5);       // MM
  return s;
};

const toISO = (d) => {
  const z = new Date(d);
  const yyyy = z.getFullYear();
  const mm = String(z.getMonth()+1).padStart(2,'0');
  const dd = String(z.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
};

/** Parse date-like value into Date.
 * Supports: 'YYYY-MM-DD', 'YYYY/MM/DD', 'YYY/MM/DD' (ROC), 'YYY.MM.DD', Excel serial, Date.
 */
const parseISO = (s) => {
  if (s == null || s === '') return null;
  if (s instanceof Date) return new Date(s.getFullYear(), s.getMonth(), s.getDate());
  if (typeof s === 'number' && isFinite(s)) {
    // Excel serial date (days since 1899-12-30)
    const ms = Math.round((s - 25569) * 86400 * 1000);
    const d = new Date(ms);
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }
  let t = String(s).trim();
  if (!t) return null;
  t = t.replace(/\./g, '/');

  // YYYY-MM-DD or YYYY/MM/DD
  if (/^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/.test(t)) {
    const [y,m,d] = t.split(/[-\/]/).map(v => parseInt(v, 10));
    return new Date(y, m-1, d);
  }
  // ROC YYY/MM/DD or ROC YYY-MM-DD
  if (/^\d{3}[-\/]\d{1,2}[-\/]\d{1,2}$/.test(t)) {
    const [y,m,d] = t.split(/[-\/]/).map(v => parseInt(v, 10));
    return new Date(y + 1911, m-1, d);
  }
  // YYYY-MM (month)
  if (/^\d{4}-\d{2}$/.test(t)) {
    const [y,m] = t.split('-').map(v => parseInt(v,10));
    return new Date(y, m-1, 1);
  }
  // Fallback
  const d = new Date(t);
  if (isNaN(d)) return null;
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
};

// Week starts on Tuesday (Tue~Mon). Return the Tuesday date of the week that contains `d`.
const weekStartTue = (d) => {
  const z = new Date(d);
  const wd = z.getDay(); // 0=Sun ... 2=Tue
  const diff = (wd - 2 + 7) % 7;
  return new Date(z.getFullYear(), z.getMonth(), z.getDate() - diff);
};

const parseMaybeDate = (v) => {
  if (!v) return null;
  if (v instanceof Date && !isNaN(v)) return v;
  if (typeof v === 'number' && isFinite(v)) {
    // Excel serial date
    const epoch = new Date(Date.UTC(1899, 11, 30));
    const d = new Date(epoch.getTime() + v * 86400 * 1000);
    // convert to local date (keep date part)
    return new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
  }
  if (typeof v === 'string') {
    // accept yyyy/mm/dd or yyyy-mm-dd
    const s = v.trim().replace(/\./g,'/').replace(/-/g,'/');
    const m = s.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);
    if (m) return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
    const d = new Date(v);
    if (!isNaN(d)) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }
  return null;
};

function ensureLibGlobal(globalName, urls, timeoutMs=20000) {
  return new Promise((resolve, reject) => {
    if (window[globalName]) return resolve(true);

    let idx = 0;
    let started = Date.now();

    const tryLoad = () => {
      if (window[globalName]) return resolve(true);
      if (Date.now() - started > timeoutMs) return reject(new Error(globalName + ' 載入逾時'));

      if (idx >= urls.length) {
        // Wait a bit for lazy loader stubs
        setTimeout(() => tryLoad(), 150);
        return;
      }

      const url = urls[idx++];
      const s = document.createElement('script');
      s.src = url;
      s.async = true;
      s.onload = () => {
        // Poll a bit because the stub may lazy-load the real file
        const pollStart = Date.now();
        const poll = () => {
          if (window[globalName]) return resolve(true);
          if (Date.now() - pollStart > 5000) return tryLoad();
          setTimeout(poll, 80);
        };
        poll();
      };
      s.onerror = () => tryLoad();
      document.head.appendChild(s);
    };

    tryLoad();
  });
}

async function loadManifest() {
  try {
    const r = await fetch('./data/manifest.json', {cache:'no-store'});
    if (!r.ok) throw new Error('manifest 讀取失敗');
    const j = await r.json();
    if (j && Array.isArray(j.files)) return j.files;
  } catch (e) {
    // fallback list (同名可自行新增)
    return [
      "2025-0701-0731晉欣半成品報廢管理表.xlsx", "2025-0801-08031晉欣半成品報廢管理表.xlsx", "2025-0901-0931晉欣半成品報廢管理表.xlsx", "2025-1001-1031晉欣半成品報廢管理表.xlsx", "2025-1101-1131晉欣半成品報廢管理表.xlsx", "2025-1201-1231晉欣半成品報廢管理表.xlsx", "2026-0101-0112晉欣半成品報廢管理表.xlsx"
    ].map(s => s);
  }
  return [];
}

function normalizeHeader(x) {
  return (x ?? '').toString().replace(/\s+/g,'').replace(/（/g,'(').replace(/）/g,')');
}

function findSheetName(wb, keyword) {
  const k = keyword.replace(/\s+/g,'');
  return wb.SheetNames.find(n => n.replace(/\s+/g,'').includes(k)) || null;
}


// Parse file start date from filename like "2025-1101-1131晉欣半成品報廢管理表.xlsx"
function parseFileStartFromName(fileName) {
  if (!fileName) return null;
  const m = String(fileName).match(/(\d{4})-(\d{2})(\d{2})-(\d{2})(\d{2})/);
  if (!m) return null;
  const y = Number(m[1]);
  const mm = Number(m[2]);
  const dd = Number(m[3]);
  if (!Number.isFinite(y) || !Number.isFinite(mm) || !Number.isFinite(dd)) return null;
  return new Date(y, mm - 1, dd);
}
function ymToIndex(ym) {
  const m = String(ym).match(/^(\d{4})-(\d{2})$/);
  if (!m) return null;
  const y = Number(m[1]);
  const mo = Number(m[2]);
  return y * 12 + mo; // mo: 1-12
}
function shiftISOByMonths(iso, deltaMonths) {
  const d = parseMaybeDate(iso);
  if (!d) return iso;
  d.setMonth(d.getMonth() + deltaMonths);
  return toISO(d);
}


function parseSummaryFromWB(wb, fileName) {
  const sname = wb.SheetNames.find(n => n.replace(/\s+/g,'').includes('日別報廢率總表')) || null;
  if (!sname) return [];
  const ws = wb.Sheets[sname];
  const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:null});
  if (!rows || !rows.length) return [];

  // 找到 header row：包含「日期」
  let hRow = -1;
  for (let i=0;i<rows.length;i++) {
    const r = (rows[i] || []).map(normalizeHeader);
    if (r.some(x => x === '日期' || x.includes('日期'))) { hRow = i; break; }
  }
  if (hRow < 0) return [];

  const header = (rows[hRow] || []).map(normalizeHeader);
  const sub = (rows[hRow+1] || []).map(normalizeHeader);

  const findIdx = (predicate) => header.findIndex(predicate);

  const idxDate = findIdx(h => h === '日期' || h.includes('日期'));
  const idxSales = findIdx(h => h.includes('營業額'));

  // 報廢額 / 超用額：避免誤抓「率」
  const idxScrapAmt = findIdx(h => h.includes('報廢') && !h.includes('率') && (h.includes('額') || h.includes('金額')));
  const idxScrapRate = findIdx(h => h.includes('報廢率'));
  const idxOverAmt = findIdx(h => h.includes('超用') && !h.includes('率') && (h.includes('額') || h.includes('金額')));
  const idxOverRate = findIdx(h => h.includes('超用率'));

  // 多層表頭（廢棄前10名 / 超用前10名 / 共用類廢棄）：
  // header 可能只有第一欄有群組名，第二欄為空；因此用「當欄或前一欄」判斷群組歸屬
  const groupAt = (i) => (header[i] || header[i-1] || '');
  const findGroupSub = (groupKw, subKw) => {
    for (let i=0;i<Math.max(header.length, sub.length);i++) {
      const g = groupAt(i);
      const s = sub[i] || '';
      if (g.includes(groupKw) && s.includes(subKw)) return i;
    }
    return -1;
  };

  const idxTopScrapAmt = findGroupSub('廢棄前10名', '金額總計');
  const idxTopScrapShare = findGroupSub('廢棄前10名', '構成比');
  const idxTopOverAmt = findGroupSub('超用前10名', '金額總計');
  const idxTopOverShare = findGroupSub('超用前10名', '構成比');
  const idxSharedAmt = findGroupSub('共用類廢棄', '金額總計');
  const idxSharedShare = findGroupSub('共用類廢棄', '構成比');

  const out = [];
  for (let r=hRow+2;r<rows.length;r++) { // hRow+1 為子表頭
    const row = rows[r];
    const d = parseMaybeDate(row[idxDate]);
    if (!d) continue;

    out.push({
      date: toISO(d),
      sales: Number(row[idxSales] ?? 0) || 0,
      scrapAmt: Number(row[idxScrapAmt] ?? 0) || 0,
      scrapRate: Number(row[idxScrapRate] ?? 0) || 0,
      overuseAmt: Number(row[idxOverAmt] ?? 0) || 0,
      overuseRate: Number(row[idxOverRate] ?? 0) || 0,
      topScrapAmt: Number(row[idxTopScrapAmt] ?? 0) || 0,
      topScrapShare: Number(row[idxTopScrapShare] ?? 0) || 0,
      topOverAmt: Number(row[idxTopOverAmt] ?? 0) || 0,
      topOverShare: Number(row[idxTopOverShare] ?? 0) || 0,
      sharedAmt: Number(row[idxSharedAmt] ?? 0) || 0,
      sharedShare: Number(row[idxSharedShare] ?? 0) || 0,
    });
  }
  
  // 有些檔案的「日別報廢率總表」日期欄可能仍保留上月快取（例如 11 月檔案顯示 10 月日期）
  // 以檔名的起始年月作為參照，若主體年月不一致，則整體平移月份，避免月份缺漏（例如缺少 11 月）。
  const fileStart = parseFileStartFromName(fileName);
  if (fileStart && out.length) {
    const expYM = toISO(fileStart).slice(0,7);
    const counts = new Map();
    for (const r of out) {
      const ym = String(r.date).slice(0,7);
      counts.set(ym, (counts.get(ym) || 0) + 1);
    }
    let domYM = null, domN = 0;
    for (const [k, v] of counts.entries()) {
      if (v > domN) { domN = v; domYM = k; }
    }
    const a = ymToIndex(domYM);
    const b = ymToIndex(expYM);
    if (a != null && b != null && domYM && expYM && domYM !== expYM) {
      const delta = b - a;
      // 僅在差距合理（±2 個月）時才平移，避免誤判
      if (Math.abs(delta) <= 2) {
        for (const r of out) r.date = shiftISOByMonths(r.date, delta);
      }
    }
  }

  return out;
}

function parseDetailsFromWB(wb, fileNameOrMeta) {
  const fileName = (typeof fileNameOrMeta === 'string')
    ? fileNameOrMeta
    : (fileNameOrMeta && fileNameOrMeta.fileName) ? String(fileNameOrMeta.fileName) : '';

  // 依檔名推回年分（避免明細頁沒有日期欄時全部變成 null）
  const baseStart = parseFileStartFromName(fileName);
  const yearHint = baseStart ? baseStart.getFullYear() : null;

  const out = [];
  const sheets = wb.SheetNames || [];

  // 支援：0731合計 / 合計0731（每日彙總頁：日期通常不在欄位內）
  function extractMMDDFromSheetName(sTrim) {
    let m = sTrim.match(/^合計\s*(\d{4})/);
    if (m) return m[1];
    m = sTrim.match(/^(\d{4})\s*合計/);
    if (m) return m[1];
    return null;
  }

  function sheetNameToISODate(mmdd) {
    if (!yearHint) return null;
    const mm = Number(mmdd.slice(0,2));
    const dd = Number(mmdd.slice(2,4));
    if (!(mm >= 1 && mm <= 12 && dd >= 1 && dd <= 31)) return null;
    return toISO(new Date(yearHint, mm - 1, dd));
  }

  for (const snRaw of sheets) {
    const sn = String(snRaw || '');
    const sTrim = sn.trim();

    const mmdd = extractMMDDFromSheetName(sTrim);
    if (!mmdd) continue;

    // 排除 01-30合計 這類「區間合計」頁
    if (sTrim.match(/^\d{2}\s*-\s*\d{2}\s*合計/)) continue;

    const sheetISO = sheetNameToISODate(mmdd);
    const ws = wb.Sheets[snRaw];
    if (!ws) continue;

    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null, blankrows: false, raw: true });
    if (!rows || !rows.length) continue;

    // 找表頭：包含「商品名稱」與「半成品名稱」
    let headerRowIdx = -1;
    for (let i = 0; i < Math.min(rows.length, 30); i++) {
      const r = rows[i] || [];
      const joined = r.map(v => String(v ?? '')).join(' ');
      if (joined.includes('商品名稱') && joined.includes('半成品名稱')) { headerRowIdx = i; break; }
    }
    if (headerRowIdx < 0) continue;

    const header = (rows[headerRowIdx] || []).map(normalizeHeader);

    const idxDate = findIndex(header, ['日期', '生產日', '日別']); // 有些格式會有日期欄
    const idxProd = findIndex(header, ['商品名稱', '品名']);
    const idxSemi = findIndex(header, ['半成品名稱', '半成品名', '半成品']);
    const idxOrder = findIndex(header, ['訂單量', '訂單數', '需求量', '需求數']);
    const idxOutput = findIndex(header, ['出料量', '出料數', '實際產量', '實際生產量', '生產量', '實際量']);
    const idxRefill = findIndex(header, ['補單量', '補單數', '加單量', '補單']);
    const idxPrice = findIndex(header, ['單價', '價格']);
    const idxDiffQty = findIndex(header, ['差異量', '差異數', '差異']);
    const idxDiffAmt = findIndex(header, ['差異金額', '差異額', '差異量(金額)', '差異量（金額）']);
    const idxScrapQty = findIndex(header, ['報廢量', '廢棄量', '報廢數', '廢棄數']);
    const idxScrapAmt = findIndex(header, ['報廢金額', '廢棄金額', '報廢量(金額)', '廢棄量(金額)', '報廢量（金額）', '廢棄量（金額）']);
    // 有些檔案只有「超用量(金額)」一欄
    const idxOverAmt = findIndex(header, ['超用金額', '超用額', '超用量(金額)', '超用量（金額）']);
    const idxOverQty = header.findIndex(h => h && h.includes('超用量') && !h.includes('金額') && !h.includes('額'));

    for (let r = headerRowIdx + 1; r < rows.length; r++) {
      const row = rows[r] || [];

      const prod = (idxProd >= 0 ? String(row[idxProd] ?? '').trim() : '') || '';
      const semi = (idxSemi >= 0 ? String(row[idxSemi] ?? '').trim() : '') || '';
      if (!prod && !semi) continue;

      // 日期：優先用欄位，沒有就用 sheet 名稱推回（0731合計 / 合計0731）
      const dateVal = idxDate >= 0 ? parseMaybeDate(row[idxDate]) : null;
      const date = dateVal || sheetISO;
      if (!date) continue; // 明細一定要有日期才能做 range filter

      const order = idxOrder >= 0 ? num(row[idxOrder]) : null;
      const output = idxOutput >= 0 ? num(row[idxOutput]) : null;
      const refill = idxRefill >= 0 ? num(row[idxRefill]) : null;
      const price = idxPrice >= 0 ? num(row[idxPrice]) : null;
      const diffQty = idxDiffQty >= 0 ? num(row[idxDiffQty]) : null;
      const diffAmt = idxDiffAmt >= 0 ? num(row[idxDiffAmt]) : null;
      const scrapQty = idxScrapQty >= 0 ? num(row[idxScrapQty]) : null;
      const scrapAmt = idxScrapAmt >= 0 ? num(row[idxScrapAmt]) : null;

      let overuseAmt = null;
      if (idxOverAmt >= 0) overuseAmt = num(row[idxOverAmt]);
      else if (idxOverQty >= 0 && price && price > 0) overuseAmt = num(row[idxOverQty]) * price;

      out.push({
        date,
        product: prod,
        semi,
        order,
        output,
        refill,
        price,
        diffQty,
        diffAmt,
        scrapQty,
        scrapAmt,
        overuseAmt
      });
    }
  }

  // 去重：同一天同品項/半成品只保留第一筆（避免合併儲存造成重複）
  const seen = new Set();
  const dedup = [];
  for (const r of out) {
    const key = `${r.date}||${r.product}||${r.semi}`;
    if (seen.has(key)) continue;
    seen.add(key);
    dedup.push(r);
  }
  return dedup;
}

    return -1;
  };

  const parseDate = (v) => {
    if (v == null || v === '') return null;
    if (typeof v === 'number') {
      // Excel date serial (1900 system)
      const d = XLSX.SSF.parse_date_code(v);
      if (d && d.y && d.m && d.d) return new Date(d.y, d.m - 1, d.d);
    }
    const s = toStr(v);
    // 支援 2025-07-01 / 2025/07/01 / 07-01 / 7/1 / 114/07/01
    let m = s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
    if (m) return new Date(+m[1], +m[2] - 1, +m[3]);
    m = s.match(/^(\d{3})[\/-](\d{1,2})[\/-](\d{1,2})/); // 民國年
    if (m) return new Date(+m[1] + 1911, +m[2] - 1, +m[3]);
    m = s.match(/^(\d{1,2})[\/-](\d{1,2})$/);
    if (m) {
      // 若只有月日，先用當前所選年補上（後續再用 filter 時比對）
      const yy = (yearHint || new Date().getFullYear());
      return new Date(+yy, +m[1] - 1, +m[2]);
    }
    return null;
  };

  // 逐 sheet 解析
  for (const sn of sheets) {
    const ws = wb.Sheets[sn];
    if (!ws) continue;

    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: '' });
    if (!rows || rows.length === 0) continue;

    // 尋找表頭列（前 40 列內）
    let headerRow = -1;
    for (let r = 0; r < Math.min(40, rows.length); r++) {
      const row = rows[r] || [];
      const joined = row.map(normKey).join('|');
      if (
        (joined.includes('商品名稱') || joined.includes('商品名')) &&
        (joined.includes('半成品名稱') || joined.includes('半成品名') || joined.includes('半成品'))
      ) {
        headerRow = r;
        break;
      }
    }
    if (headerRow < 0) continue;

    const hdr = (rows[headerRow] || []).map(toStr);

    const idxDate = (() => {
      let i = findCol(hdr, ['日期', '生產日', '日別', '生產日期']);
      if (i >= 0) return i;
      // fallback：找最像日期的欄（前 5 欄）
      for (let c = 0; c < Math.min(5, hdr.length); c++) {
        const d = parseDate((rows[headerRow + 1] || [])[c]);
        if (d) return c;
      }
      return -1;
    })();

    const idxProd = findCol(hdr, ['商品名稱', '商品名']);
    const idxSemi = findCol(hdr, ['半成品名稱', '半成品名', '半成品']);
    if (idxProd < 0 || idxSemi < 0) continue;

    const idxOrder = findCol(hdr, ['訂單需求', '訂單量', '訂單數量', '訂單']);
    const idxOut = findCol(hdr, ['實際產出', '出料量', '實際出料量', '實際產量', '產出量']);
    const idxRefill = findCol(hdr, ['補單量', '補單']);
    const idxPrice = findCol(hdr, ['單價', '價格']);
    const idxDiffQty = findCol(hdr, ['差異量', '差異數量']);
    const idxDiffAmt = findCol(hdr, ['差異金額', '差異量(金額)', '差異(元)', '差異額']);
    const idxScrapQty = findCol(hdr, ['報廢量', '廢棄量']);
    const idxScrapAmt = findCol(hdr, ['報廢金額', '廢棄金額', '報廢額', '廢棄額']);
    const idxOverQty = findCol(hdr, ['超用量']);
    const idxOverAmt = findCol(hdr, ['超用金額', '超用額']);

    for (let r = headerRow + 1; r < rows.length; r++) {
      const row = rows[r] || [];
      const prod = toStr(row[idxProd]);
      const semi = toStr(row[idxSemi]);
      if (!prod && !semi) continue;

      // 日期：沒有日期欄位也允許（某些「01-30合計」可能只做彙總），先記 null
      const dateObj = idxDate >= 0 ? parseDate(row[idxDate]) : null;

      const num = (v) => {
        if (v == null || v === '') return null;
        if (typeof v === 'number') return v;
        const s = String(v).replace(/,/g, '').trim();
        if (!s) return null;
        const x = Number(s);
        return Number.isFinite(x) ? x : null;
      };

      const order = idxOrder >= 0 ? (num(row[idxOrder]) ?? 0) : 0;
      const outQty = idxOut >= 0 ? (num(row[idxOut]) ?? 0) : 0;
      const refill = idxRefill >= 0 ? (num(row[idxRefill]) ?? 0) : 0;
      const price = idxPrice >= 0 ? (num(row[idxPrice]) ?? null) : null;

      const diffQty = idxDiffQty >= 0 ? (num(row[idxDiffQty]) ?? null) : null;
      const diffAmt = idxDiffAmt >= 0 ? (num(row[idxDiffAmt]) ?? null) : null;
      const scrapQty = idxScrapQty >= 0 ? (num(row[idxScrapQty]) ?? null) : null;
      const scrapAmt = idxScrapAmt >= 0 ? (num(row[idxScrapAmt]) ?? null) : null;
      const overuseQty = idxOverQty >= 0 ? (num(row[idxOverQty]) ?? null) : null;
      const overuseAmt = idxOverAmt >= 0 ? (num(row[idxOverAmt]) ?? null) : null;

      out.push({
        date: dateObj ? dateObj.toISOString().slice(0, 10) : null,
        product: prod,
        semi,
        order,
        outQty,
        refill,
        price,
        prodRate: order > 0 ? (outQty / order) : null,
        diffQty,
        diffAmt,
        scrapQty,
        scrapAmt,
        overuseQty,
        overuseAmt,
        __sheet: sn
      });
    }
  }

  // 去除重覆：以 date+product+semi 作 key（若 date 為 null，則只保留第一筆）
  const seen = new Set();
  const dedup = [];
  for (const it of out) {
    const k = (it.date || 'null') + '|' + it.product + '|' + it.semi;
    if (seen.has(k)) continue;
    seen.add(k);
    dedup.push(it);
  }
  return dedup;
}
async function loadAllData() {
  $('dataStatus').innerHTML = '<span class="loader"></span> 載入中...';
  $('dataStatus').classList.remove('chip');
  $('dataStatus').classList.add('chip');

  // Ensure libs
  await ensureLibGlobal('XLSX', [
    './xlsx.full.min.js',
    'https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js'
  ]);
  await ensureLibGlobal('Chart', [
    './chart.umd.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js'
  ]);

  const files = await loadManifest();
  if (!files.length) throw new Error('manifest 無任何檔案');

  let sum = [];
  let det = [];
  for (const f of files) {
    const url = './data/' + encodeURIComponent(f);
    const r = await fetch(url, {cache:'no-store'});
    if (!r.ok) throw new Error('讀取失敗：' + f);
    const ab = await r.arrayBuffer();
    const wb = XLSX.read(ab, {type:'array', cellDates:true});
    sum = sum.concat(parseSummaryFromWB(wb, f));
    det = det.concat(parseDetailsFromWB(wb, f));
  }

  // dedupe summary by date (keep last)
  const m = new Map();
  for (const r of sum) m.set(r.date, r);
  state.summary = Array.from(m.values()).sort((a,b)=>safeLocaleCompare(a.date,b.date));
  state.details = det.sort((a,b)=>safeLocaleCompare(a.date,b.date));

  if (!state.summary.length) throw new Error('未解析到日別報廢率總表資料');
  state.dateMin = state.summary[0].date;
  state.dateMax = state.summary[state.summary.length-1].date;

  $('dataStatus').textContent = '已載入 ' + files.length + ' 份檔案';
}

function buildSelectors() {
  const years = Array.from(new Set(state.summary.map(r => r.date.slice(0,4)))).sort();
  state.years = years;
  $('yearSel').innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

  // months by year (only show months with data)
  const monthsByYear = new Map();
  for (const r of state.summary) {
    const y = r.date.slice(0,4);
    const mm = r.date.slice(5,7);
    if (!monthsByYear.has(y)) monthsByYear.set(y, new Set());
    monthsByYear.get(y).add(mm);
  }
  state.monthsByYear = {};
  for (const [y, set] of monthsByYear.entries()) {
    state.monthsByYear[y] = Array.from(set).sort();
  }

  // week list (週二～週一) built from all summary dates
  const weekStart = (dateStr) => {
    const d = parseMaybeDate(dateStr);
    if (!d) return null;
    const day = d.getDay(); // 0 Sun ... 6 Sat
    const diff = (day - 2 + 7) % 7; // Tuesday = 2
    const s = new Date(d);
    s.setDate(s.getDate() - diff);
    return s;
  };

  const wkMap = new Map();
  for (const r of state.summary) {
    const s = weekStart(r.date);
    if (!s) continue;
    const key = toISO(s);
    if (!wkMap.has(key)) {
      const e = new Date(s);
      e.setDate(e.getDate() + 6);
      wkMap.set(key, { start: key, end: toISO(e) });
    }
  }
  state.weeksAll = Array.from(wkMap.values()).sort((a,b)=>safeLocaleCompare(a.start,b.start));

  const renderMonthOptions = (year) => {
    const months = state.monthsByYear[year] || [];
    if (!months.length) {
      $('monthSel').innerHTML = `<option value="">—</option>`;
      return;
    }
    $('monthSel').innerHTML = months.map(mm => {
      const mNum = Number(mm);
      return `<option value="${mm}">${mNum} 月</option>`;
    }).join('');
  };

  const filterWeeksForYM = (year, month) => {
    if (!year || !month) return [];
    const s = new Date(Number(year), Number(month) - 1, 1);
    const e = new Date(Number(year), Number(month), 0);
    const out = [];
    for (const w of state.weeksAll) {
      const ws = new Date(w.start);
      const we = new Date(w.end);
      // overlap with month range
      if (we < s || ws > e) continue;
      out.push(w);
    }
    return out;
  };

  const renderWeekOptions = (year, month, preferStart=null) => {
    const weeks = filterWeeksForYM(year, month);
    state.weeks = weeks;
    if (!weeks.length) {
      $('weekSel').innerHTML = `<option value="">（無週別資料）</option>`;
      $('weekSel').value = '';
      return;
    }
    $('weekSel').innerHTML = weeks.map(w => `<option value="${w.start}">${w.start} ～ ${w.end}</option>`).join('');
    if (preferStart && weeks.some(w => w.start === preferStart)) {
      $('weekSel').value = preferStart;
    } else {
      $('weekSel').value = weeks[weeks.length - 1].start; // latest in month
    }
  };

  // expose to wireUI
  state.renderMonthOptions = renderMonthOptions;
  state.renderWeekOptions = renderWeekOptions;

  // default: latest year
  const latestYear = state.dateMax.slice(0,4);
  $('yearSel').value = latestYear;
  state.selection.year = latestYear;

  // month options for year, default to latest month in data (or last available)
  renderMonthOptions(latestYear);
  let defMonth = state.dateMax.slice(5,7);
  const availMonths = state.monthsByYear[latestYear] || [];
  if (availMonths.length && !availMonths.includes(defMonth)) defMonth = availMonths[availMonths.length - 1] || defMonth;
  $('monthSel').value = defMonth || '';
  state.selection.month = defMonth || '';

  // week options constrained by selected year+month
  const prefer = (() => {
    const s = weekStart(state.dateMax);
    return s ? toISO(s) : null;
  })();
  renderWeekOptions(latestYear, defMonth, prefer);
  state.selection.weekStart = $('weekSel').value || '';

  // day defaults
  $('daySel').value = state.dateMax;
  state.selection.day = state.dateMax;

  $('rangeStart').value = state.dateMin;
  $('rangeEnd').value = state.dateMax;
  state.selection.start = state.dateMin;
  state.selection.end = state.dateMax;

  // default KPI selection (single)
  for (const btn of document.querySelectorAll('button[data-kpi-single]')) {
    btn.classList.toggle('active', btn.dataset.kpiSingle === state.kpiSelected[0]);
  }
}


function getDateRange() {
  const mode = state.mode;
  let start = state.dateMin;
  let end = state.dateMax;

  if (mode === 'year') {
    const y = $('yearSel').value;
    start = `${y}-01-01`;
    end = `${y}-12-31`;
  } else if (mode === 'month') {
    const y = $('yearSel').value;
    const m = $('monthSel').value;
    start = `${y}-${m}-01`;
    const d = new Date(Number(y), Number(m), 0);
    end = toISO(d);
  } else if (mode === 'week') {
    const ws = $('weekSel').value;
    const w = state.weeks.find(x => x.start === ws);
    if (w) { start = w.start; end = w.end; }
  } else if (mode === 'day') {
    const d = $('daySel').value;
    start = d;
    end = d;
  } else if (mode === 'range') {
    start = $('rangeStart').value || state.dateMin;
    end = $('rangeEnd').value || state.dateMax;
  }

  // clamp to dataset
  if (start < state.dateMin) start = state.dateMin;
  if (end > state.dateMax) end = state.dateMax;
  if (start > end) [start,end] = [end,start];

  state.selection.start = start;
  state.selection.end = end;

  return {start, end};
}

function filterByRange(arr, start, end) {
  return arr.filter(r => r.date >= start && r.date <= end);
}

function aggGranularity(start, end) {
  // 顯示粒度：依「模式」決定（避免不同卡片/圖表行為不一致）
  if (state.mode === 'year') return 'month';
  if (state.mode === 'month') return 'week'; // 月別以週別顯示（週二~週一）

  const sd = parseMaybeDate(start);
  const ed = parseMaybeDate(end);
  const days = Math.round((ed - sd) / 86400000) + 1;

  // 其他模式：範圍太大則用週別，其餘用日別
  if (days > 90) return 'week';
  return 'day';
}

function groupKeyByGran(dateStr, gran) {
  if (gran === 'day') return dateStr;
  if (gran === 'month') return dateStr.slice(0, 7);
  if (gran === 'week') {
    const d = parseISO(dateStr);
    const s = weekStartTue(d);
    // 以「週起始日」做 key，x 軸可自然用 MM-DD 顯示
    return toISO(s);
  }
  return dateStr;
}


function aggregateSeries(rows, metric, gran, start = null, end = null) {
  const buckets = new Map();

  const hasRange = (start instanceof Date) && (end instanceof Date);
  const startT = hasRange ? start.getTime() : 0;
  const endT   = hasRange ? end.getTime() : 0;

  for (const r of rows) {
    let k;

    if (gran === 'week') {
      const d = parseISO(r.date);
      const ws = weekStartTue(d); // 週二~週一
      // 月別模式：只顯示「起始日在該月範圍內」的週別
      if (hasRange && state.mode === 'month') {
        const t = ws.getTime();
        if (t < startT || t > endT) continue;
      }
      k = toISO(ws);
    } else {
      k = groupKeyByGran(r.date, gran);
    }

    if (!buckets.has(k)) buckets.set(k, {k, n: 0, sum: 0});
    const b = buckets.get(k);
    b.n += 1;
    b.sum += (Number(r[metric]) || 0);
  }

  let keys = Array.from(buckets.keys()).sort((a, b) => safeLocaleCompare(a,b));

  // 年別：固定顯示 1~12 月（即使某些月份無資料，也保留 x 軸刻度）
  if (gran === 'month' && state.mode === 'year' && hasRange) {
    const y = String(start.getFullYear());
    keys = Array.from({ length: 12 }, (_, i) => `${y}-${String(i + 1).padStart(2, '0')}`);
  }

  const values = keys.map(k => {
    const b = buckets.get(k);
    if (!b) return null;
    // rate/share：以平均呈現；金額/數量：同樣維持「平均/日」(bucket 內日平均)
    return b.sum / Math.max(1, b.n);
  });

  return { labels: keys, values };
}


function updateKPICards(srows) {
  const n = srows.length || 1;
  const sum = (k) => srows.reduce((a,b)=>a + (Number(b[k])||0), 0);
  const avgAmt = (k) => sum(k) / n;
  const avgRate = (k) => sum(k) / n;

  const sales = avgAmt('sales');
  const scrapAmt = avgAmt('scrapAmt');
  const scrapRate = avgRate('scrapRate');
  const overAmt = avgAmt('overuseAmt');
  const overRate = avgRate('overuseRate');

  $('kpiSales').textContent = fmtMoney(sales);
$('kpiScrapAmt').textContent = fmtMoney(scrapAmt);
$('kpiScrapRate').textContent = fmtPct(scrapRate);
$('kpiOverAmt').textContent = fmtMoney(overAmt);
$('kpiOverRate').textContent = fmtPct(overRate);
// top cards
  const topScrapAmt = avgAmt('topScrapAmt');
  const topScrapShare = avgRate('topScrapShare');
  $('topScrapAmt').textContent = fmtMoney(topScrapAmt);
  $('topScrapShare').textContent = fmtPct(topScrapShare);

  const topOverAmt = avgAmt('topOverAmt');
  const topOverShare = avgRate('topOverShare');
  $('topOverAmt').textContent = fmtMoney(topOverAmt);
  $('topOverShare').textContent = fmtPct(topOverShare);

  const sharedAmt = avgAmt('sharedAmt');
  const sharedShare = avgRate('sharedShare');
  $('sharedAmt').textContent = fmtMoney(sharedAmt);
  $('sharedShare').textContent = fmtPct(sharedShare);

  const badge = $('sharedBadge');
  badge.className = '';
  if (Number.isFinite(sharedShare)) {
    if (sharedShare <= 0.15) {
      badge.className = 'badge-ok';
      badge.textContent = '達標';
    } else {
      badge.className = 'badge-danger';
      badge.textContent = '超過 KPI';
    }
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

function destroyChart(key) {
  const c = state.charts[key];
  if (c) { c.destroy(); state.charts[key] = null; }
}


function computeBounds(values, kind) {
  const arr = (values || []).map(Number).filter(v => Number.isFinite(v));
  if (!arr.length) return null;

  let mn = Math.min(...arr);
  let mx = Math.max(...arr);

  // padding
  if (mn === mx) {
    const pad = (mn === 0) ? 1 : Math.max(0.02, Math.abs(mn) * 0.08);
    mn -= pad; mx += pad;
  } else {
    const pad = Math.max(0.02, (mx - mn) * 0.08);
    mn -= pad; mx += pad;
  }

  // clamp mins (do NOT clamp max for rate; 實際生產率可能 > 100%)
  if (kind === 'amt' || kind === 'qty' || kind === 'rate') mn = Math.max(0, mn);

  // ensure sane ordering
  if (mx <= mn) mx = mn + 1;

  return { min: mn, max: mx };
}


function renderKPIChart(srows, start, end) {
  const gran = aggGranularity(start, end);

  const metric = state.kpiSelected && state.kpiSelected.length ? state.kpiSelected[0] : null;
  if (!metric) return;

  const _key = `kpi|${metric}|${toISO(start)}|${toISO(end)}|${gran}`;
  if (state._kpiChartKey === _key) return;
  state._kpiChartKey = _key;
  destroyChart('kpi');

  const metricMeta = {
    sales: {label:'營業額', kind:'amt'},
    scrapAmt: {label:'報廢額', kind:'amt'},
    overuseAmt: {label:'超用額', kind:'amt'},
    scrapRate: {label:'報廢率', kind:'rate'},
    overuseRate: {label:'超用率', kind:'rate'},
  };
  const meta = metricMeta[metric] || {label: metric, kind:'amt'};

  const s = aggregateSeries(srows, metric, gran, start, end);
  const labels = s.labels;
  const bounds = computeBounds(s.values, meta.kind);

  const unitText = meta.kind === 'rate' ? '%' : 'NT$';
  const fmtTick = (v) => {
    const n = Number(v);
    if (!Number.isFinite(n)) return '';
    if (meta.kind === 'rate') return (n * 100).toFixed(1);
    return Math.round(n).toLocaleString('zh-TW');
  };
  const fmtTip = (v) => meta.kind === 'rate' ? fmtPct(v) : fmtMoney(v);

  const ctx = $('kpiChart').getContext('2d');
  state.charts.kpi = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: meta.label,
          data: s.values,
          tension: 0.25,
          pointRadius: labels.length > 45 ? 0 : 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: (items) => items && items.length ? items[0].label : '',
            label: (ctx) => ' ' + meta.label + ': ' + fmtTip(ctx.parsed.y)
          }
        }
      },
      scales: {
        x: {
          ticks: {
            callback: function(value) {
              return shortLabel(this.getLabelForValue(value));
            }
          }
        },
        y: {
          beginAtZero: false,
          title: { display: true, text: unitText },
          min: bounds ? bounds.min : undefined,
          max: bounds ? bounds.max : undefined,
          ticks: { callback: (v) => fmtTick(v) }
        }
      }
    }
  });
}

function renderRightChart(srows, start, end) {
  const gran = aggGranularity(start, end);

  const _key = `right|${state.rightMode}|${state.rightMetric}|${toISO(start)}|${toISO(end)}|${gran}`;
  if (state._rightChartKey === _key) return;
  state._rightChartKey = _key;
  destroyChart('right');

  let amtKey, shareKey, title;
  if (state.rightMode === 'scrapTop10') {
    amtKey = 'topScrapAmt'; shareKey = 'topScrapShare'; title = '廢棄前10名';
  } else if (state.rightMode === 'overTop10') {
    amtKey = 'topOverAmt'; shareKey = 'topOverShare'; title = '超用前10名';
  } else {
    amtKey = 'sharedAmt'; shareKey = 'sharedShare'; title = '共用類廢棄';
  }

  const isShare = state.rightMetric === 'share';
  const metricKey = isShare ? shareKey : amtKey;
  const meta = { kind: isShare ? 'rate' : 'amt' };
  const unitText = meta.kind === 'rate' ? '%' : 'NT$';
  const fmtTick = (v) => {
    const n = Number(v);
    if (!Number.isFinite(n)) return '';
    if (meta.kind === 'rate') return (n * 100).toFixed(1);
    return Math.round(n).toLocaleString('zh-TW');
  };
  const fmtTip = (v) => meta.kind === 'rate' ? fmtPct(v) : fmtMoney(v);

  const s = aggregateSeries(srows, metricKey, gran, start, end);
  const labels = s.labels;
  const bounds = computeBounds(s.values, meta.kind);

  let dsLabel = title + (isShare ? '｜構成比（平均）' : '｜金額總計（平均/日）');
  if (state.rightMode === 'shared' && isShare) dsLabel = title + '｜構成比(KPI15%)（平均）';

  const ctx = $('rightChart').getContext('2d');
  state.charts.right = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: dsLabel,
          data: s.values,
          tension: 0.25,
          pointRadius: labels.length > 45 ? 0 : 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: (items) => items && items.length ? items[0].label : '',
            label: (ctx) => ' ' + dsLabel + ': ' + fmtTip(ctx.parsed.y)
          }
        }
      },
      scales: {
        x: {
          ticks: {
            callback: function(value) {
              return shortLabel(this.getLabelForValue(value));
            }
          }
        },
        y: {
          beginAtZero: false,
          title: { display: true, text: unitText },
          min: bounds ? bounds.min : undefined,
          max: bounds ? bounds.max : undefined,
          ticks: { callback: (v) => fmtTick(v) }
        }
      }
    }
  });
}

function aggregateGroups(drows) {
  const map = new Map();
  for (const r of drows) {
    const key = r.product + '||' + r.semi;
    if (!map.has(key)) {
      map.set(key, {
        key,
        product: r.product,
        semi: r.semi,
        order: 0,
        output: 0,
        refillQty: 0,
        diffAmt: 0,
        scrapAmt: 0,
        overuseAmt: 0
      });
    }
    const o = map.get(key);
    o.order += Number(r.order) || 0;
    o.output += Number(r.output) || 0;
    o.refillQty += Number(r.refill) || 0;
    o.diffAmt += Math.abs(Number(r.diffAmt) || 0);
    o.scrapAmt += Number(r.scrapAmt) || 0;
    o.overuseAmt += Number(r.overuseAmt) || 0;
  }
  const out = Array.from(map.values());
  for (const o of out) {
    o.prodRate = o.order > 0 ? (o.output / o.order) : null;
  }
  return out;
}

function applyGroupFilterAndRender(drows) {
  const rangeKey = state.selection.start + '|' + state.selection.end;
  if (state._groupRangeKey !== rangeKey) {
    state.groupRows = aggregateGroups(drows);
    state._groupRangeKey = rangeKey;
  }

  const kwProd = $('productSearch').value.trim().toLowerCase();
  const kwSemi = $('semiSearch').value.trim().toLowerCase();

  let filtered = state.groupRows;
  if (kwProd) {
    filtered = filtered.filter(r => r.product.toLowerCase().includes(kwProd));
  }
  if (kwSemi) {
    filtered = filtered.filter(r => r.semi.toLowerCase().includes(kwSemi));
  }

  const sort = $('sortSel').value;
  const by = (k) => (a,b) => (Number(b[k])||0) - (Number(a[k])||0);
  if (sort === 'diffAmt') filtered.sort(by('diffAmt'));
  if (sort === 'scrapAmt') filtered.sort(by('scrapAmt'));
  if (sort === 'overuseAmt') filtered.sort(by('overuseAmt'));
  if (sort === 'refillQty') filtered.sort(by('refillQty'));

  state.filteredGroups = filtered.slice(0,200);
  $('groupCount').textContent = state.filteredGroups.length.toLocaleString('zh-TW');

  const tbody = $('groupTbody');
  tbody.innerHTML = '';
  for (const r of state.filteredGroups) {
    const tr = document.createElement('tr');
    tr.className = 'cursor-pointer';
    tr.innerHTML = `
      <td>${r.product}</td>
      <td class="muted">${r.semi}</td>
      <td class="text-right mono">${fmtInt(r.refillQty)}</td>
      <td class="text-right mono">${r.prodRate==null?'—':fmtPct(r.prodRate)}</td>
      <td class="text-right mono">${fmtMoney(r.diffAmt)}</td>
      <td class="text-right mono">${fmtMoney(r.scrapAmt)}</td>
      <td class="text-right mono">${fmtMoney(r.overuseAmt)}</td>
    `;
    tr.addEventListener('click', () => {
      state.selectedKey = r.key;
      renderSelectedItem();
    });
    tbody.appendChild(tr);
  }

  // if selected item no longer in list, hide
  if (state.selectedKey && !state.groupRows.some(x => x.key === state.selectedKey)) {
    state.selectedKey = null;
    $('itemPanel').classList.add('hidden');
  }
}

function buildSuggestion(list, keyword, onPick) {
  const kw = keyword.trim().toLowerCase();
  if (!kw) return [];
  const hits = list.filter(r => (r.product + ' ' + r.semi).toLowerCase().includes(kw)).slice(0,8);
  return hits.map(r => ({
    label: `${r.product}｜${r.semi}`,
    key: r.key
  }));
}

function renderSuggest(containerId, items, onClick) {
  const wrap = $(containerId);
  if (!items.length) {
    wrap.classList.add('hidden');
    wrap.innerHTML = '';
    return;
  }
  wrap.classList.remove('hidden');
  wrap.className = 'mt-1 card p-2';
  wrap.innerHTML = items.map((it, idx) => `
    <div class="px-2 py-2 rounded-lg hover:bg-slate-50 cursor-pointer text-sm" data-idx="${idx}">
      <span class="mono text-xs muted mr-2">#${idx+1}</span>${it.label}
    </div>
  `).join('');
  wrap.querySelectorAll('[data-idx]').forEach(el => {
    el.addEventListener('click', () => {
      onClick(items[Number(el.dataset.idx)]);
      wrap.classList.add('hidden');
      wrap.innerHTML = '';
    });
  });
}

function getSelectedRangeRows() {
  const {start, end} = getDateRange();
  const srows = filterByRange(state.summary, start, end);
  const drows = filterByRange(state.details, start, end);
  return {start, end, srows, drows};
}

function renderAll() {
  const { start, end, srows, drows } = getSelectedRangeRows();
  state.view = { start, end, srows, drows };

  updateKPICards(srows);
  renderKPIChart(srows, start, end);
  renderRightChart(srows, start, end);
  applyGroupFilterAndRender(drows);
}

function renderKPIOnly() {
  if (!state.view) return renderAll();
  renderKPIChart(state.view.srows, state.view.start, state.view.end);
}

function renderRightOnly() {
  if (!state.view) return renderAll();
  renderRightChart(state.view.srows, state.view.start, state.view.end);
}




function renderSelectedItem() {
  if (!state.selectedKey) {
    $('itemPanel').classList.add('hidden');
    return;
  }
  const {start, end} = getDateRange();
  const drows = filterByRange(state.details, start, end).filter(r => (r.product + '||' + r.semi) === state.selectedKey);
  if (!drows.length) {
    $('itemPanel').classList.add('hidden');
    return;
  }

  // aggregate by date
  const m = new Map();
  for (const r of drows) {
    if (!m.has(r.date)) m.set(r.date, {
      date: r.date,
      product: r.product,
      semi: r.semi,
      order: 0, output: 0, refill: 0,
      priceSum: 0, priceN: 0,
      diffQty: 0, diffAmt: 0,
      scrapQty: 0, scrapAmt: 0,
      overuseAmt: 0
    });
    const o = m.get(r.date);
    o.order += Number(r.order)||0;
    o.output += Number(r.output)||0;
    o.refill += Number(r.refill)||0;
    if (Number.isFinite(r.price) && r.price>0) { o.priceSum += r.price; o.priceN += 1; }
    o.diffQty += Number(r.diffQty)||0;
    o.diffAmt += Number(r.diffAmt)||0;
    o.scrapQty += Number(r.scrapQty)||0;
    o.scrapAmt += Number(r.scrapAmt)||0;
    o.overuseAmt += Number(r.overuseAmt)||0;
  }
  const daily = Array.from(m.values()).sort((a,b)=>safeLocaleCompare(a.date,b.date));
  for (const o of daily) {
    o.price = o.priceN ? (o.priceSum / o.priceN) : null;
    o.prodRate = o.order>0 ? (o.output / o.order) : null;
    o.overuseQty = (o.price && o.price>0) ? (o.overuseAmt / o.price) : null;
  }
  state.selectedDaily = daily;

  const title = daily[0].product + '｜' + daily[0].semi;
  $('itemTitle').textContent = `${title}（${start} ～ ${end}）`;
  $('itemPanel').classList.remove('hidden');

  renderItemChart(daily);
  renderDetailTable(daily);
}

function renderItemChart(daily) {
  destroyChart('item');

  const metric = state.itemMetricSelected || 'diffAmt';
  // sync UI active state
  document.querySelectorAll('button[data-item-single]').forEach(b => {
    b.classList.toggle('active', b.dataset.itemSingle === metric);
  });

  const meta = {
    prodRate: {
      label: '實際生產率',
      kind: 'rate',
      unitTitle: '%',
      get: (r) => r.prodRate,
      fmt: (v) => fmtPct(v),
      tick: (v) => (Number(v) * 100).toFixed(1) + '%'
    },
    diffAmt: {
      label: '差異金額',
      kind: 'amt',
      unitTitle: 'NT$',
      get: (r) => r.diffAmt,
      fmt: (v) => fmtMoney(v),
      tick: (v) => Math.round(Number(v)).toLocaleString('zh-TW')
    },
    scrapAmt: {
      label: '報廢金額',
      kind: 'amt',
      unitTitle: 'NT$',
      get: (r) => r.scrapAmt,
      fmt: (v) => fmtMoney(v),
      tick: (v) => Math.round(Number(v)).toLocaleString('zh-TW')
    },
    overuseAmt: {
      label: '超用金額',
      kind: 'amt',
      unitTitle: 'NT$',
      get: (r) => r.overuseAmt,
      fmt: (v) => fmtMoney(v),
      tick: (v) => Math.round(Number(v)).toLocaleString('zh-TW')
    },
    refillQty: {
      label: '補單量',
      kind: 'qty',
      unitTitle: '數量',
      get: (r) => r.refill,
      fmt: (v) => fmtInt(v),
      tick: (v) => Math.round(Number(v)).toLocaleString('zh-TW')
    }
  };

  const m = meta[metric] || meta.diffAmt;

  // === X 軸顯示規則（依目前時間範圍模式）===
  // 年別：以「月」為單位（1月、2月…）
  // 月別：以「週別」為單位（顯示週別起始日：MM/DD）
  // 週別：以「日別」為單位（顯示 M/D）
  // 其他（日別/指定範圍）：維持原本 MM-DD
  const mode = state.mode || 'range';
  const parsed = daily
    .map(r => ({ ...r, _d: parseMaybeDate(r.date) }))
    .filter(r => r._d && !isNaN(r._d));

  parsed.sort((a,b) => a._d - b._d);

  const fmtMD = (d) => `${d.getMonth()+1}/${d.getDate()}`;
  const fmtMMDD = (d) => `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;

  const weekStartTue = (d) => {
    // 週二～週一：找出「該日所屬週」的週二作為 weekStart
    const wd = d.getDay(); // 0=Sun ... 2=Tue
    const diff = (wd - 2 + 7) % 7;
    return new Date(d.getFullYear(), d.getMonth(), d.getDate() - diff);
  };

  const buckets = new Map(); // key -> { d:Date, label:string, sum:number, cnt:number }
  const isRate = (m.kind === 'rate');

  const addToBucket = (key, d, label, v) => {
    if (!buckets.has(key)) buckets.set(key, { d, label, sum: 0, cnt: 0 });
    const b = buckets.get(key);
    if (v == null || !Number.isFinite(Number(v))) return;
    b.sum += Number(v);
    b.cnt += 1;
  };

  if (mode === 'year') {
    const ySel = Number(state.selection.year || $('yearSel').value || (parsed[0] ? parsed[0]._d.getFullYear() : new Date().getFullYear()));

    // 年別：X 軸固定顯示整年 1~12 月（即使沒有資料也保留月份）
    for (let mi = 0; mi < 12; mi++) {
      const key = `${ySel}-${String(mi+1).padStart(2,'0')}`;
      const d0 = new Date(ySel, mi, 1);
      const label = `${mi+1}月`;
      if (!buckets.has(key)) buckets.set(key, { d: d0, label, sum: 0, cnt: 0 });
    }

    for (const r of parsed) {
      const d = r._d;
      if (d.getFullYear() !== ySel) continue;
      const monthIdx = d.getMonth(); // 0-11
      const key = `${ySel}-${String(monthIdx+1).padStart(2,'0')}`;
      const v = m.get(r);
      // 年別：金額/數量用「加總」，比率用「平均」
      addToBucket(key, new Date(ySel, monthIdx, 1), `${monthIdx+1}月`, v);
    }
  } else if (mode === 'month') {
    for (const r of parsed) {
      const ws = weekStartTue(r._d);
      const key = toISO(ws);
      const label = fmtMMDD(ws);
      const v = m.get(r);
      // 月別：金額/數量用「加總」，比率用「平均」
      addToBucket(key, ws, label, v);
    }
  } else if (mode === 'week') {
    for (const r of parsed) {
      const d = r._d;
      const key = toISO(d);
      const label = fmtMD(d);
      const v = m.get(r);
      addToBucket(key, d, label, v);
    }
  } else {
    // day / range：保持原本的 MM-DD 顯示
    for (const r of parsed) {
      const d = r._d;
      const key = toISO(d);
      const label = shortLabel(toISO(d));
      const v = m.get(r);
      addToBucket(key, d, label, v);
    }
  }

  const points = Array.from(buckets.values()).sort((a,b) => a.d - b.d);
  const labels = points.map(p => p.label);
  const values = points.map(p => {
    if (!p.cnt) return null;
    // 比率 => 平均；金額/數量 => 加總（依你要的「以單位彙總」呈現）
    return isRate ? (p.sum / p.cnt) : p.sum;
  });

  const bounds = computeBounds(values, m.kind);

  const ctx = $('itemChart').getContext('2d');

  state.charts.item = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: m.label,
        data: values,
        borderWidth: 3,
        tension: 0.25,
        spanGaps: true,
        pointRadius: 3,
        pointHoverRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (c) => `${m.label}：${m.fmt(c.parsed.y)}`
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { maxRotation: 0, autoSkip: true }
        },
        y: {
          beginAtZero: false,
          min: bounds ? bounds.min : undefined,
          max: bounds ? bounds.max : undefined,
          title: { display: true, text: m.unitTitle },
          ticks: { callback: (v) => m.tick(v) }
        }
      }
    }
  });
}

function renderDetailTable(daily) {
  const tbody = $('detailTbody');
  tbody.innerHTML = '';
  for (const r of daily) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${r.date}</td>
      <td>${r.product}</td>
      <td class="muted">${r.semi}</td>
      <td class="text-right mono">${fmtInt(r.order)}</td>
      <td class="text-right mono">${fmtInt(r.output)}</td>
      <td class="text-right mono">${fmtInt(r.refill)}</td>
      <td class="text-right mono">${r.price==null?'—':fmtMoney(r.price).replace('NT$ ','')}</td>
      <td class="text-right mono">${r.prodRate==null?'—':fmtPct(r.prodRate)}</td>
      <td class="text-right mono">${fmtInt(r.diffQty)}</td>
      <td class="text-right mono">${fmtMoney(r.diffAmt)}</td>
      <td class="text-right mono">${fmtInt(r.scrapQty)}</td>
      <td class="text-right mono">${fmtMoney(r.scrapAmt)}</td>
      <td class="text-right mono">${r.overuseQty==null?'—':(r.overuseQty.toFixed(2))}</td>
      <td class="text-right mono">${fmtMoney(r.overuseAmt)}</td>
    `;
    tbody.appendChild(tr);
  }
}

function exportSelectedCsv() {
  const rows = state.selectedDaily;
  if (!rows || !rows.length) return;
  const header = ['日期','商品名','半成品名','訂單需求','實際產出','補單','單價','實際生產率','差異量','差異金額','報廢量','報廢金額','超用量','超用金額'];
  const lines = [header.join(',')];

  const esc = (s) => {
    const t = (s ?? '').toString();
    if (/[",\n]/.test(t)) return '"' + t.replace(/"/g,'""') + '"';
    return t;
  };

  for (const r of rows) {
    lines.push([
      r.date,
      esc(r.product),
      esc(r.semi),
      r.order ?? '',
      r.output ?? '',
      r.refill ?? '',
      r.price == null ? '' : r.price.toFixed(2),
      r.prodRate == null ? '' : r.prodRate.toFixed(4),
      r.diffQty ?? '',
      r.diffAmt ?? '',
      r.scrapQty ?? '',
      r.scrapAmt ?? '',
      r.overuseQty == null ? '' : r.overuseQty.toFixed(4),
      r.overuseAmt ?? ''
    ].join(','));
  }
  const blob = new Blob(['\ufeff' + lines.join('\n')], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  const name = (rows[0].product + '_' + rows[0].semi + '_' + state.selection.start + '_' + state.selection.end).replace(/\s+/g,'');
  a.href = URL.createObjectURL(blob);
  a.download = name + '.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function wireUI() {
  // mode buttons
  document.querySelectorAll('button.seg-btn[data-mode]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('button.seg-btn[data-mode]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.mode = btn.dataset.mode;
      syncModeUI();
    });
  });

  // right chart buttons
  document.querySelectorAll('button.seg-btn[data-right]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('button.seg-btn[data-right]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.rightMode = btn.dataset.right;
      renderRightOnly();
    });
  });

  // right chart metric buttons（金額 / 構成比）
  document.querySelectorAll('button.seg-btn[data-right-metric]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('button.seg-btn[data-right-metric]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.rightMetric = btn.dataset.rightMetric;
      renderRightOnly();
    });
  });

  // keep week options aligned with selected year/month（不需按「套用」也會更新週別清單）
  $('yearSel').addEventListener('change', () => {
    const y = $('yearSel').value;
    if (state.renderMonthOptions) state.renderMonthOptions(y);
    const m = $('monthSel').value;
    if (state.renderWeekOptions) state.renderWeekOptions(y, m, null);
  });
  $('monthSel').addEventListener('change', () => {
    const y = $('yearSel').value;
    const m = $('monthSel').value;
    if (state.renderWeekOptions) state.renderWeekOptions(y, m, null);
  });

  // apply
  $('applyBtn').addEventListener('click', () => {
    state.selection.year = $('yearSel').value;
    state.selection.month = $('monthSel').value;
    state.selection.weekStart = $('weekSel').value;
    state.selection.day = $('daySel').value;
    state.selection.start = $('rangeStart').value;
    state.selection.end = $('rangeEnd').value;
    renderAll();
    renderSelectedItem();
  });

  $('todayBtn').addEventListener('click', () => {
    // set to latest date (day mode)
    state.mode = 'day';
    document.querySelectorAll('button.seg-btn[data-mode]').forEach(b => b.classList.toggle('active', b.dataset.mode==='day'));
    syncModeUI();
    $('daySel').value = state.dateMax;
    $('applyBtn').click();
  });

  $('reloadBtn').addEventListener('click', async () => {
    try {
      await init(true);
      toast('已重新載入資料');
    } catch (e) {
      toast('重新載入失敗：' + e.message);
    }
  });

  // KPI selection (single)
  document.querySelectorAll('button[data-kpi-single]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('button[data-kpi-single]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.kpiSelected = [btn.dataset.kpiSingle];
      renderKPIOnly();
    });
  });
// item chart selection (single)
  document.querySelectorAll('button[data-item-single]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('button[data-item-single]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.itemMetricSelected = btn.dataset.itemSingle;
      if (!state.selectedKey) return;
      renderSelectedItem();
    });
  });

  // group filters
  $('sortSel').addEventListener('change', () => renderAll());
  $('productSearch').addEventListener('input', () => {
    const items = buildSuggestion(state.groupRows, $('productSearch').value, null);
    renderSuggest('productSuggest', items, (it) => {
      const row = state.groupRows.find(r => r.key === it.key);
      if (!row) return;
      $('productSearch').value = row.product;
      $('semiSearch').value = row.semi;
      state.selectedKey = row.key;
      $('productSuggest').classList.add('hidden');
      $('semiSuggest').classList.add('hidden');
      renderAll();
      renderSelectedItem();
    });
    renderAll();
  });
  $('semiSearch').addEventListener('input', () => {
    const items = buildSuggestion(state.groupRows, $('semiSearch').value, null);
    renderSuggest('semiSuggest', items, (it) => {
      const row = state.groupRows.find(r => r.key === it.key);
      if (!row) return;
      $('productSearch').value = row.product;
      $('semiSearch').value = row.semi;
      state.selectedKey = row.key;
      $('productSuggest').classList.add('hidden');
      $('semiSuggest').classList.add('hidden');
      renderAll();
      renderSelectedItem();
    });
    renderAll();
  });
  $('clearSearchBtn').addEventListener('click', () => {
    $('productSearch').value = '';
    $('semiSearch').value = '';
    $('productSuggest').classList.add('hidden');
    $('semiSuggest').classList.add('hidden');
    renderAll();
  });

  $('exportCsvBtn').addEventListener('click', exportSelectedCsv);
}

function syncModeUI() {
  $('yearWrap').classList.toggle('hidden', false);
  $('monthWrap').classList.toggle('hidden', !(state.mode === 'month' || state.mode === 'week'));
  $('weekWrap').classList.toggle('hidden', state.mode !== 'week');
  $('dayWrap').classList.toggle('hidden', state.mode !== 'day');
  $('rangeWrap').classList.toggle('hidden', state.mode !== 'range');
}

async function init(force=false) {
  try {
    await loadAllData();
    buildSelectors();
    wireUI();
    initStickyControls();
    syncModeUI();
    renderAll();
    state.loaded = true;
  } catch (e) {
    console.error(e);
    $('dataStatus').textContent = '載入失敗：' + e.message;
    toast('載入失敗：' + e.message);
  }
}

init();
</script>

</body>
</html>
